function renderChart() {
  const nycGeo = cachedNycGeo;
  chartContainer.innerHTML = '';

  const width = chartContainer.clientWidth || 800;
  const H = 740;
  const M = 16;

  const wrap = document.createElement('div');
  wrap.className = 'chart-wrap';

  const title = document.createElement('h2');
  title.textContent = 'SAT in the City';
  title.style.color = '#e6ecff';
  title.style.font = '600 20px system-ui, sans-serif';
  title.style.margin = '0 0 4px 0';
  wrap.appendChild(title);

  const subtitle = document.createElement('div');
  subtitle.textContent = `Average SAT Scores by School and Borough (${state.year})`;
  subtitle.style.color = '#9aa4c7';
  subtitle.style.font = '14px system-ui, sans-serif';
  subtitle.style.marginBottom = '8px';
  wrap.appendChild(subtitle);

  // === COLOR SCALE + LEGEND (MOVED UP) ===
  const colorScale = computeColorScale();
  const legendDiv = document.createElement('div');
  legendDiv.style.marginBottom = '10px';
  legendDiv.appendChild(makeColorLegend(colorScale, width));
  wrap.appendChild(legendDiv);

  // Help button & overlay
  const helpBtn = document.createElement('button');
  helpBtn.textContent = 'Help';
  helpBtn.className = 'help-btn';
  wrap.appendChild(helpBtn);

  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  const modal = document.createElement('div');
  modal.className = 'overlay-modal';

  const modalTitle = document.createElement('div');
  modalTitle.textContent = 'How to read this map';
  modalTitle.style.font = '600 16px system-ui, sans-serif';
  modalTitle.style.marginBottom = '8px';

  const modalBody = document.createElement('div');
  modalBody.style.color = '#c6cefb';
  modalBody.style.lineHeight = '1.45';
  modalBody.innerHTML = `
      <div style="margin-bottom:8px">
        <b>What you are seeing</b><br/>
        Each circle is a NYC public high school. Color reflects SAT performance for the selected metric, scaled within the current data range. Size increases with higher scores.
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div>
          <b>Explore</b><br/>
          • Hover a school for full scores and details<br/>
          • Click a school to pin its tooltip (if pin mode is enabled)<br/>
          • Hover a borough to see that borough’s average<br/>
          • Use your trackpad or mouse to pan and zoom
        </div>
        <div>
          <b>Controls</b><br/>
          • Use the year control to switch between 2010 and 2012<br/>
          • Change the metric to view reading, math, writing, or total<br/>
          • Use search, minimum score, and borough filters to focus
        </div>
      </div>
      <div style="margin-top:8px">
        When nothing is hovered, the box in the top right shows the NYC-wide average for the current year and metric.
      </div>
    `;

  const modalFooter = document.createElement('div');
  modalFooter.className = 'overlay-footer';

  const dontShowLabel = document.createElement('label');
  const dontShowCb = document.createElement('input');
  dontShowCb.type = 'checkbox';
  dontShowLabel.appendChild(dontShowCb);
  dontShowLabel.appendChild(document.createTextNode('Do not show on load'));
  modalFooter.appendChild(dontShowLabel);

  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Close';
  modalFooter.appendChild(closeBtn);

  modal.appendChild(modalTitle);
  modal.appendChild(modalBody);
  modal.appendChild(modalFooter);
  overlay.appendChild(modal);
  wrap.appendChild(overlay);

  const openHelp = () => { overlay.style.display = 'flex'; };
  const closeHelp = () => {
    overlay.style.display = 'none';
    if (dontShowCb.checked) {
      try { localStorage.setItem('satMapOnboardSeen', '1'); } catch {}
    }
  };
  helpBtn.addEventListener('click', openHelp);
  closeBtn.addEventListener('click', closeHelp);
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeHelp();
  });
  wrap.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeHelp();
  });

  try {
    if (localStorage.getItem('satMapOnboardSeen') !== '1') {
      setTimeout(openHelp, 50);
    }
  } catch {}

  const svg = d3.select(wrap).append("svg")
    .attr("width", width)
    .attr("height", H - 70);

  const projection = d3.geoMercator()
    .fitExtent([[M, M], [width - M, H - 100]], nycGeo);
  const path = d3.geoPath(projection);

  const gBrush  = svg.append("g");
  const gMap    = svg.append("g");
  const gNodes  = svg.append("g");
  const gLabels = svg.append("g");

  const nodeTT = d3.select(wrap).append("div").attr("class","tooltip");
  const boroTT = d3.select(wrap).append("div").attr("class","tooltip");

  const idle = d3.select(wrap).append("div")
    .style("position","absolute")
    .style("right","16px")
    .style("top","16px")
    .style("pointer-events","none")
    .style("background","#0b132f")
    .style("color","#e6ecff")
    .style("border","1px solid #2a356c")
    .style("border-radius","12px")
    .style("padding","10px 12px")
    .style("font","12px system-ui, sans-serif")
    .style("box-shadow","0 10px 30px rgba(0,0,0,.35)")
    .style("opacity", 1);

  const placeTooltip = (event, el) => {
    const rect = wrap.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    el.style("left", (x + 14) + "px").style("top", (y + 14) + "px");
  };

  const normalizeBoro = s => (s ?? "").toString().trim().toUpperCase();

  const boroStats = (boroName) => {
    const key = normalizeBoro(boroName);
    const arr = filteredPoints.filter(d =>
      normalizeBoro(d.borough) === key && Number.isFinite(metricAccessor(d))
    );
    const mean = arr.length ? d3.mean(arr, metricAccessor) : null;
    return { mean, count: arr.length };
  };

  const boroStatsAll = (boroName) => {
    const key = normalizeBoro(boroName);
    const arr = points.filter(d =>
      normalizeBoro(d.borough) === key && Number.isFinite(metricAccessor(d))
    );
    const mean = arr.length ? d3.mean(arr, metricAccessor) : null;
    return { mean, count: arr.length };
  };

  const cityStats = () => {
    const arr = points.filter(d => Number.isFinite(metricAccessor(d)));
    const mean = arr.length ? Math.round(d3.mean(arr, metricAccessor)) : '—';
    const count = arr.length;
    const label =
      state.metric === "math" ? "Avg Math" :
      state.metric === "read" ? "Avg Reading" :
      state.metric === "write" ? "Avg Writing" : "Avg Total";
    return { mean, count, label };
  };

  const updateIdle = () => {
    const { mean, count, label } = cityStats();
    idle.html(
      `<div style="font-weight:700">NYC Average (${state.year})</div>
       <div style="color:#9aa4c7;margin-top:2px">${count} schools</div>
       <div style="margin-top:6px">${label}: <b>${mean}</b>${state.metric === "total" ? " / 2400" : ""}</div>`
    );
  };
  updateIdle();

  const tipHTMLSchool = (d) => {
    const s = getStats(d, state.year);
    return `
      <div style='font-weight:700'>${d.name}</div>
      <div style='color:#9aa4c7;font-size:12px'>${d.borough} • DBN ${d.DBN} • Year ${state.year}</div>
      <div style='display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;font-size:12px'>
        <div><div style='color:#9aa4c7'>Reading</div><b>${s.read ?? "—"}</b></div>
        <div><div style='color:#9aa4c7'>Math</div><b>${s.math ?? "—"}</b></div>
        <div><div style='color:#9aa4c7'>Writing</div><b>${s.write ?? "—"}</b></div>
        <div><div style='color:#9aa4c7'>Total</div><b>${s.total ?? "—"}</b> / 2400</div>
      </div>`;
  };

  const tipHTMLBorough = (boroName) => {
    const { mean, count } = boroStats(boroName);
    const { count: totalCount } = boroStatsAll(boroName);
    const label =
      state.metric === "math" ? "Avg Math" :
      state.metric === "read" ? "Avg Reading" :
      state.metric === "write" ? "Avg Writing" : "Avg Total";
    const value = (mean != null) ? Math.round(mean) : "—";
    const countLine = count > 0
      ? `Year ${state.year} • ${count} schools in view`
      : (totalCount > 0 ? `Year ${state.year} • 0 in view (of ${totalCount} total)` : `Year ${state.year} • 0 schools`);
    return `
      <div style='font-weight:700'>${boroName}</div>
      <div style='color:#9aa4c7;font-size:12px'>${countLine}</div>
      <div style='margin-top:6px'>${label}: <b>${value}</b>${state.metric === "total" ? " / 2400" : ""}</div>
    `;
  };

  // Borough shapes
  gMap.selectAll("path")
    .data(nycGeo.features)
    .join("path")
      .attr("class","boro")
      .attr("d", path)
      .attr("fill","#1c2448")
      .attr("stroke","#2f3c7a")
      .attr("stroke-width",0.8)
      .on("mouseenter", function(event, f) {
        idle.style("opacity", 0);
        d3.select(this).attr("fill","#2e3c7a");
        boroTT.html(tipHTMLBorough(f.properties.BoroName)).style("opacity", 1);
        placeTooltip(event, boroTT.node());
      })
      .on("mousemove", function(event){ placeTooltip(event, boroTT.node()); })
      .on("mouseleave", function() {
        d3.select(this).attr("fill","#1c2448");
        boroTT.style("opacity",0);
        updateIdle();
        idle.style("opacity", 1);
      });

  gLabels.selectAll("text")
    .data(nycGeo.features)
    .join("text")
      .attr("transform", d => `translate(${path.centroid(d)})`)
      .attr("text-anchor","middle")
      .attr("fill","#7f8eca")
      .attr("font-size",12)
      .text(d => d.properties.BoroName);

  const showSchool = (event, d) => {
    idle.style("opacity", 0);
    state.detail = d;
    renderStatsPanel();
    nodeTT.html(tipHTMLSchool(d)).style("opacity", 1);
    placeTooltip(event, nodeTT.node());
  };
  const moveSchool = (event) => {
    placeTooltip(event, nodeTT.node());
  };
  const hideSchool = () => {
    nodeTT.style("opacity", 0);
    if (!state.pinMode) {
      state.detail = null;
      renderStatsPanel();
    }
    updateIdle();
    idle.style("opacity", 1);
  };

  gNodes.selectAll("circle")
    .data(filteredPoints, d => d.DBN ?? d.name)
    .join(
      enter => enter.append("circle")
        .attr("class","school")
        .attr("cx", d => projection([d.lon, d.lat])[0])
        .attr("cy", d => projection([d.lon, d.lat])[1])
        .attr("r", 0)
        .attr("fill", d => colorScale(metricAccessor(d)))
        .attr("opacity", 0.92)
        .on("mouseenter", showSchool)
        .on("mousemove", moveSchool)
        .on("mouseleave", hideSchool)
        .on("click", (ev, d) => { state.detail = d; renderStatsPanel(); showSchool(ev, d); })
        .call(e => e.transition().duration(450).attr("r", d => radiusAccessor(d))),
      update => update.call(u => u.transition().duration(400)
        .attr("fill", d => colorScale(metricAccessor(d)))
        .attr("r", d => radiusAccessor(d))
        .attr("cx", d => projection([d.lon, d.lat])[0])
        .attr("cy", d => projection([d.lon, d.lat])[1])),
      exit => exit.transition().duration(300).attr("r", 0).remove()
    );

  const zoom = d3.zoom()
    .scaleExtent([0.8, 12])
    .on("zoom", ({transform}) => {
      gMap.attr("transform", transform);
      gNodes.attr("transform", transform);
      gLabels.attr("transform", transform);
      gBrush.attr("transform", transform);
    });
  svg.call(zoom);

  const caption = document.createElement('div');
  caption.className = 'caption';
  caption.textContent =
    "Each circle represents a public high school in NYC. Color indicates SAT performance scaled to the current data range. Hover schools or boroughs for details. Click a school to pin it. When not hovering, the NYC-wide average for the selected year is shown.";
  wrap.appendChild(caption);

  chartContainer.appendChild(wrap);
}
